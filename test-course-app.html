<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="wi    <div class="test-section">
        <h3>üîß Login Troubleshooting</h3>
        <button class="button" onclick="debugUserPassword()">üîç Debug User Password</button>
        <button class="button" onclick="fixPbLogin()" style="background: #e74c3c;">üîß Fix pb.petel26@gmail.com Login</button>
        <button class="button" onclick="removePbAccount()" style="background: #dc3545;">üóëÔ∏è Remove pb.petel26@gmail.com Account</button>
        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
            Having trouble logging in? Use these tools to debug and fix password issues, or remove the account to start fresh.
        </p>
    </div>ce-width, initial-scale=1.0">
    <title>Course App Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 15px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            margin: 5px;
            padding: 10px 20px;
            background: #007cba;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .button:hover {
            background: #005a8b;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .debug {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
            border-left: 4px solid #007cba;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .iframe-container {
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 400px;
            border: none;
        }
    </style>
</head>
<body>
    <h1>üï∫üíÉ Course App Testing Dashboard</h1>
    
    <div class="test-section">
        <h3>Quick Status Check</h3>
        <div id="status-display" class="status">Checking application status...</div>
        <div class="debug" id="debug-output">Loading debug information...</div>
    </div>
    
    <div class="test-section">
        <h3>Navigation</h3>
        <a href="courses.html" class="button" target="_blank">üìö Open Course App</a>
        <a href="test-admin.html" class="button" target="_blank">üõ†Ô∏è Admin Testing Tools</a>
        <button class="button" onclick="refreshStatus()">üîÑ Refresh Status</button>
        <button class="button" onclick="clearAllData()">üßπ Clear All Data</button>
    </div>
    
    <div class="test-section">
        <h3>Quick Tests</h3>
        <button class="button" onclick="testAuthentication()">Test Authentication</button>
        <button class="button" onclick="testAdminPanel()">Test Admin Panel</button>
        <button class="button" onclick="testPaymentFlow()">Test Payment Flow</button>
    </div>
    
    <div class="test-section">
        <h3>Password System Tests</h3>
        <button class="button" onclick="testPasswordSystem()">Test Password System</button>
        <button class="button" onclick="testRegistrationFlow()">Test Registration Flow</button>
    </div>
    
    <div class="test-section">
        <h3>üîß Login Troubleshooting</h3>
        <button class="button" onclick="debugUserPassword()">Debug User Password</button>
        <button class="button" onclick="fixPbLogin()" style="background: #e74c3c;">üîß Fix pb.petel26@gmail.com Login</button>
        <p style="font-size: 0.9em; color: #666; margin-top: 10px;">
            Having trouble logging in? Use these tools to debug and fix password issues.
        </p>
    </div>
    
    <div class="test-section">
        <h3>Course App Preview</h3>
        <div class="iframe-container">
            <iframe src="courses.html" id="course-iframe"></iframe>
        </div>
        <button class="button" onclick="reloadIframe()">Reload Preview</button>
    </div>

    <script>
        function updateStatus(message, isSuccess = true) {
            const statusDiv = document.getElementById('status-display');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + (isSuccess ? 'success' : 'error');
        }
        
        function updateDebug(info) {
            document.getElementById('debug-output').textContent = info;
        }
        
        function refreshStatus() {
            const currentUser = localStorage.getItem('currentUser');
            const pendingPayments = localStorage.getItem('pendingPayments');
            const QLDUsers = localStorage.getItem('QLDUsers');
            
            const userCount = QLDUsers ? Object.keys(JSON.parse(QLDUsers)).length : 0;
            const paymentCount = pendingPayments ? JSON.parse(pendingPayments).length : 0;
            const isLoggedIn = !!currentUser;
            
            if (isLoggedIn) {
                const user = JSON.parse(currentUser);
                updateStatus(`‚úÖ Logged in as: ${user.name || user.email}`, true);
            } else {
                updateStatus('üë§ Not logged in', true);
            }
            
            const debugInfo = `AUTHENTICATION STATUS:
${isLoggedIn ? '‚úÖ User is logged in' : '‚ùå No user logged in'}
${isLoggedIn ? 'User: ' + JSON.parse(currentUser).email : ''}

STORAGE DATA:
üìä Total Users: ${userCount}
üí≥ Pending Payments: ${paymentCount}

CURRENT USER DATA:
${currentUser ? JSON.stringify(JSON.parse(currentUser), null, 2) : 'None'}

PENDING PAYMENTS:
${pendingPayments ? JSON.stringify(JSON.parse(pendingPayments), null, 2) : 'None'}

ALL USERS:
${QLDUsers ? JSON.stringify(JSON.parse(QLDUsers), null, 2) : 'None'}`;
            
            updateDebug(debugInfo);
        }
        
        function clearAllData() {
            if (confirm('Clear all stored data? This will log you out and remove all test data.')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('pendingPayments');
                localStorage.removeItem('QLDUsers');
                updateStatus('üßπ All data cleared', true);
                refreshStatus();
            }
        }
        
        function testAuthentication() {
            updateStatus('üîë Testing authentication...', true);
            
            // Create a test user
            const testUser = {
                id: 'test_' + Date.now(),
                name: 'Test User',
                email: 'test@example.com',
                passwordHash: 'demo123',
                ownedCourses: [],
                joinDate: new Date().toISOString(),
                isAdmin: false
            };
            
            // Save test user
            const users = JSON.parse(localStorage.getItem('QLDUsers') || '{}');
            users[testUser.email] = testUser;
            localStorage.setItem('QLDUsers', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(testUser));
            
            updateStatus('‚úÖ Test authentication successful!', true);
            refreshStatus();
        }
        
        function testAdminPanel() {
            updateStatus('üëë Testing admin panel...', true);
            
            // Create admin user
            const adminUser = {
                id: 'admin_' + Date.now(),
                name: 'Michelle (Admin)',
                email: 'michelle@queerlatindance.com',
                passwordHash: 'admin123',
                ownedCourses: ['salsa-fundamentals', 'bachata-sensual'],
                joinDate: new Date().toISOString(),
                isAdmin: true
            };
            
            // Save admin user
            const users = JSON.parse(localStorage.getItem('QLDUsers') || '{}');
            users[adminUser.email] = adminUser;
            localStorage.setItem('QLDUsers', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(adminUser));
            
            // Create test payment
            const testPayment = {
                email: 'student@example.com',
                userEmail: 'student@example.com',
                firstName: 'Test',
                lastName: 'Student',
                name: 'Test Student',
                courseName: 'Salsa Fundamentals',
                series: 'Salsa Fundamentals',
                courseId: 'salsa-fundamentals',
                paymentMethod: 'Zelle',
                method: 'Zelle',
                timestamp: new Date().toISOString(),
                status: 'demo-pending',
                amount: 49,
                price: 49
            };
            
            const pendingPayments = JSON.parse(localStorage.getItem('pendingPayments') || '[]');
            pendingPayments.push(testPayment);
            localStorage.setItem('pendingPayments', JSON.stringify(pendingPayments));
            
            updateStatus('‚úÖ Admin panel test data created!', true);
            refreshStatus();
        }
        
        function testPaymentFlow() {
            updateStatus('üí∞ Testing payment flow...', true);
            
            // Create student user
            const studentUser = {
                id: 'student_' + Date.now(),
                name: 'Jane Student',
                email: 'pb.petel26@gmail.com',
                passwordHash: 'student123',
                ownedCourses: [],
                joinDate: new Date().toISOString(),
                isAdmin: false
            };
            
            // Save student user
            const users = JSON.parse(localStorage.getItem('QLDUsers') || '{}');
            users[studentUser.email] = studentUser;
            localStorage.setItem('QLDUsers', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(studentUser));
            
            updateStatus('‚úÖ Payment flow test user created!', true);
            refreshStatus();
        }
        
        function reloadIframe() {
            const iframe = document.getElementById('course-iframe');
            iframe.src = iframe.src;
        }
        
        function testPasswordSystem() {
            updateStatus('üîê Testing password system...', true);
            
            // Simulate the password hashing process
            function hashPassword(password) {
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString();
            }
            
            // Test password
            const testPassword = 'mySecretPassword123';
            const hashedPassword = hashPassword(testPassword);
            
            // Test verification
            const correctPassword = hashPassword('mySecretPassword123');
            const wrongPassword = hashPassword('wrongPassword');
            
            const testResults = `PASSWORD TESTING RESULTS:

ORIGINAL PASSWORD: "${testPassword}"
HASHED VERSION: "${hashedPassword}"

VERIFICATION TESTS:
‚úÖ Correct password matches: ${hashedPassword === correctPassword}
‚ùå Wrong password matches: ${hashedPassword === wrongPassword}

HOW IT WORKS:
1. When you register: Password ‚Üí Hash ‚Üí Store hash
2. When you login: Password ‚Üí Hash ‚Üí Compare with stored hash
3. If hashes match ‚Üí Login successful
4. If hashes don't match ‚Üí Login failed

CURRENT USER AUTHENTICATION:`;
            
            // Show current user info
            const currentUser = localStorage.getItem('currentUser');
            const users = localStorage.getItem('QLDUsers');
            
            if (currentUser) {
                const user = JSON.parse(currentUser);
                const allUsers = JSON.parse(users || '{}');
                const storedUser = allUsers[user.email];
                
                updateDebug(testResults + `
LOGGED IN AS: ${user.name} (${user.email})
STORED PASSWORD HASH: ${storedUser ? storedUser.passwordHash : 'Not found'}
REGISTRATION DATE: ${storedUser ? storedUser.joinDate : 'N/A'}`);
            } else {
                updateDebug(testResults + `
‚ùå No user currently logged in
To test: Register or login first`);
            }
            
            updateStatus('‚úÖ Password system test complete!', true);
        }
        
        function testRegistrationFlow() {
            updateStatus('üìù Testing full registration flow...', true);
            
            // Clear any existing data for clean test
            const testEmail = 'test-registration@example.com';
            const testPassword = 'testPassword123';
            
            // Simulate registration
            function hashPassword(password) {
                let hash = 0;
                for (let i = 0; i < password.length; i++) {
                    const char = password.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString();
            }
            
            const newUser = {
                id: 'test_' + Date.now(),
                name: 'Test Registration User',
                email: testEmail,
                passwordHash: hashPassword(testPassword),
                purchasedCourses: [],
                ownedCourses: [],
                progress: {},
                joinDate: new Date().toISOString(),
                lastLogin: new Date().toISOString(),
                isAdmin: false
            };
            
            // Save user (registration)
            const users = JSON.parse(localStorage.getItem('QLDUsers') || '{}');
            users[testEmail] = newUser;
            localStorage.setItem('QLDUsers', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(newUser));
            
            // Test login with correct password
            const loginAttempt1 = hashPassword('testPassword123');
            const loginAttempt2 = hashPassword('wrongPassword');
            
            const testResults = `REGISTRATION FLOW TEST:

1. REGISTRATION:
   Email: ${testEmail}
   Password: "testPassword123"
   Hashed: ${newUser.passwordHash}
   ‚úÖ Account created successfully

2. LOGIN ATTEMPTS:
   Correct password hash: ${loginAttempt1}
   Wrong password hash: ${loginAttempt2}
   
   ‚úÖ Correct password would work: ${loginAttempt1 === newUser.passwordHash}
   ‚ùå Wrong password would fail: ${loginAttempt2 === newUser.passwordHash}

3. PERSISTENCE:
   ‚úÖ User data saved to localStorage
   ‚úÖ User automatically logged in after registration
   ‚úÖ User data will persist across browser sessions`;
            
            updateDebug(testResults);
            updateStatus('‚úÖ Registration flow test complete!', true);
            refreshStatus(); // Update the main status
        }
        
        function fixPbLogin() {
            const email = 'pb.petel26@gmail.com';
            const password = prompt('Enter the password you want to use for pb.petel26@gmail.com:');
            if (!password) return;
            
            updateStatus('üîß Fixing login for pb.petel26@gmail.com...', true);
            
            // Debug current password
            const users = JSON.parse(localStorage.getItem('QLDUsers') || '{}');
            const user = users[email];
            
            if (user) {
                // Simple hash function (same as in course-app.js)
                function hashPassword(password) {
                    let hash = 0;
                    for (let i = 0; i < password.length; i++) {
                        const char = password.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    return hash.toString();
                }
                
                const oldHash = user.passwordHash;
                const newHash = hashPassword(password);
                
                // Update password
                user.passwordHash = newHash;
                user.lastPasswordReset = new Date().toISOString();
                users[email] = user;
                
                localStorage.setItem('QLDUsers', JSON.stringify(users));
                
                updateStatus(`‚úÖ Password fixed for ${email}!`, true);
                
                const debugInfo = `PASSWORD RESET COMPLETED:

Email: ${email}
New Password: "${password}"
Old Hash: ${oldHash}
New Hash: ${newHash}

‚úÖ You can now login with:
Email: ${email}
Password: ${password}

Go to the course app and try logging in!`;
                
                updateDebug(debugInfo);
            } else {
                updateStatus('‚ùå User not found', false);
                updateDebug(`User ${email} not found in storage.`);
            }
        }
        
        function debugUserPassword() {
            const email = prompt('Enter email to debug:') || 'pb.petel26@gmail.com';
            updateStatus('üîç Debugging user password...', true);
            
            const users = JSON.parse(localStorage.getItem('QLDUsers') || '{}');
            const user = users[email];
            
            if (user) {
                // Simple hash function
                function hashPassword(password) {
                    let hash = 0;
                    for (let i = 0; i < password.length; i++) {
                        const char = password.charCodeAt(i);
                        hash = ((hash << 5) - hash) + char;
                        hash = hash & hash;
                    }
                    return hash.toString();
                }
                
                // Test common passwords
                const testPasswords = ['demo123', 'password', 'admin123', '123456', email.split('@')[0], 'test123'];
                let foundPassword = null;
                
                const passwordTests = testPasswords.map(testPwd => {
                    const testHash = hashPassword(testPwd);
                    const matches = testHash === user.passwordHash;
                    if (matches) foundPassword = testPwd;
                    return `${matches ? '‚úÖ' : '‚ùå'} "${testPwd}" -> ${testHash} (${matches ? 'MATCH!' : 'no match'})`;
                }).join('\n');
                
                const debugInfo = `PASSWORD DEBUG FOR: ${email}

USER DATA:
Name: ${user.name}
Email: ${user.email}
Join Date: ${user.joinDate}
Stored Hash: ${user.passwordHash}

TESTING COMMON PASSWORDS:
${passwordTests}

${foundPassword ? `üéâ FOUND PASSWORD: "${foundPassword}"` : '‚ùå Password not found in common list'}

TO FIX: Click "Fix pb.petel26@gmail.com Login" and enter your desired password.`;
                
                updateDebug(debugInfo);
                updateStatus(foundPassword ? `‚úÖ Found password: "${foundPassword}"` : '‚ùì Password not in common list', true);
            } else {
                updateDebug(`‚ùå User ${email} not found in storage`);
                updateStatus('‚ùå User not found', false);
            }
        }
        
        function removePbAccount() {
            const email = 'pb.petel26@gmail.com';
            
            if (confirm(`Are you sure you want to completely remove the account for ${email}? This will allow you to register fresh.`)) {
                updateStatus('üóëÔ∏è Removing pb.petel26@gmail.com account...', true);
                
                // Remove from QLDUsers
                const users = JSON.parse(localStorage.getItem('QLDUsers') || '{}');
                const userExisted = !!users[email];
                delete users[email];
                localStorage.setItem('QLDUsers', JSON.stringify(users));
                
                // Remove from currentUser if logged in as this user
                const currentUser = localStorage.getItem('currentUser');
                let wasLoggedIn = false;
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    if (user.email === email) {
                        localStorage.removeItem('currentUser');
                        wasLoggedIn = true;
                    }
                }
                
                // Remove any pending payments for this user
                const pendingPayments = JSON.parse(localStorage.getItem('pendingPayments') || '[]');
                const originalPaymentCount = pendingPayments.length;
                const filteredPayments = pendingPayments.filter(payment => {
                    const paymentEmail = payment.email || payment.userEmail;
                    return paymentEmail !== email;
                });
                localStorage.setItem('pendingPayments', JSON.stringify(filteredPayments));
                const removedPayments = originalPaymentCount - filteredPayments.length;
                
                // Update status
                updateStatus(`‚úÖ Account ${email} removed successfully!`, true);
                
                const debugInfo = `ACCOUNT REMOVAL COMPLETED:

Email: ${email}
${userExisted ? '‚úÖ User account deleted' : '‚ùå User account was not found'}
${wasLoggedIn ? '‚úÖ Logged out current user' : '‚ÑπÔ∏è User was not logged in'}
${removedPayments > 0 ? `‚úÖ Removed ${removedPayments} pending payment(s)` : '‚ÑπÔ∏è No pending payments to remove'}

üéØ Result: You can now register with ${email} as a fresh new account!
Go to the course app and try signing up.`;
                
                updateDebug(debugInfo);
                refreshStatus(); // Update the main status
            }
        }
        
        // Load status on page load
        window.onload = refreshStatus;
        
        // Auto-refresh every 5 seconds
        setInterval(refreshStatus, 5000);
    </script>
</body>
</html>
